<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yo!</title>

    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Yo!">
    <meta name="description" content="Get attention from far away - Perfect for airports, emergencies, and distance communication">

    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkF5ZSwgWW8hIiwKICAic2hvcnRfbmFtZSI6ICJBeWUsIFlvISIsCiAgImRlc2NyaXB0aW9uIjogIkdldCBhdHRlbnRpb24gZnJvbSBmYXIgYXdheSAtIFBlcmZlY3QgZm9yIGFpcnBvcnRzLCBlbWVyZ2VuY2llcywgYW5kIGRpc3RhbmNlIGNvbW11bmljYXRpb24iLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDAwMDAiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdC1wcmltYXJ5IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lnZG1sbGQwSnZlRDBpTUNBd0lERXlPQ0F4TWpnaUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK1BISmxZM1FnZUQwaU1TSWdlVDBpTVNJZ2QybGtkR2c5SWpFeU5pSWdhR1ZwWjJoMFBTSXhNall5SUdacGJHdzlJaU0yTmpkbFpXRWlMejQ4ZEdWNGRDQjRQU0kyTkNJZ2VUMGlOalFpSUdacGJHdzlJaU0zTWpZeUlpQm1iMjUwTFhOcGVtVTlJalEwSWlCbWIyNTBMWGRsYVdkb2REMGlPVEF3SWlCMFpYaDBMV0Z1WTJodmNqMGliV2xrWkd4bElpQmtiMjFwYm1GdWRDMWlZWE5sYkdsdVpUMGlZMlZ1ZEdWeUlqNUJaUzQ4TDNSbGVIUStQSFJsZUhRZ2VEMGlOalFpSUhrOUlqazFJaUJtYVd4c1BTSWpOekkyTWlJZ1ptOXVkQzF6YVhwbFBTSXpNaUlnWm05dWRDMTNaV2xuYUhROUlqZ3dNQ0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJZ1pHOXRhVzVoYm5RdFltRnpaV3hwYm1VOUltTmxiblJsY2lJK1dXOGhQQzl0WlhoMFBqd3ZjM1puUGc9PSIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAic2l6ZXMiOiAiMTI4eDEyOCIKICAgIH0KICBdLAogICJjYXRlZ29yaWVzIjogWyJ1dGlsaXRpZXMiLCAicHJvZHVjdGl2aXR5Il0sCiAgImxhbmciOiAiZW4iCn0K">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #000;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 8px;
            color: #000;
        }

        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 40px;
            justify-content: center;
            align-items: center;
        }

        .btn {
            border: 2px solid #000;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            background: #fff;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: #000;
            color: #fff;
        }

        .btn-split {
            display: flex;
            border: 2px solid #000;
            border-radius: 50px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .btn-split:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-split-main {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            background: #fff;
            color: #000;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            border-right: 1px solid #000;
        }

        .btn-split-main:hover {
            background: #64cf4e;
            color: #fff;
        }

        .btn-split-dropdown {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            background: #fff;
            color: #000;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-split-dropdown:hover {
            background: #64cf4e;
            color: #fff;
        }

        .btn-play {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }

        .btn-play:hover {
            background: #0095ff;
            color: #fff;
        }

        .btn-clear {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }

        .btn-clear:hover {
            background: #ff4d4d;
            color: #fff;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border: 2px solid #000;
            border-radius: 12px;
            z-index: 1000;
            top: 60px;
            right: 0;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 1px solid #eee;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .dropdown-item.danger {
            color: #dc3545;
        }

        .dropdown-item.danger:hover {
            background-color: #dc3545;
            color: white;
        }

        .pages-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .page-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
            border: 2px solid #eee;
        }

        .page-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            border-color: #000;
        }

        .page-preview {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Arial Black', Arial, sans-serif;
            font-weight: 900;
            text-align: center;
            line-height: 1.1;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 2rem;
            color: #fff;
            background: #000;
            position: relative;
            padding: 5%;
        }

        .page-text {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-family: inherit;
            font-weight: inherit;
            font-size: inherit;
            color: inherit;
            text-align: center;
            line-height: inherit;
            white-space: pre-wrap;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            padding: 5%;
            cursor: text;
        }

        .page-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            max-height: 38px;
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(242, 242, 242, 1);
            border-radius: 24px;
            padding: 4px;
            transition: all 0.2s ease;
            z-index: 20;
        }

        .page-controls.collapsed {
            width: 48px;
            height: 48px;
            justify-content: center;
            background: transparent;
        }

        .page-controls.collapsed .control-btn:not(.toggle-btn) {
            display: none;
        }

        .page-controls.collapsed .control-separator {
            display: none;
        }

        .control-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #000;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .control-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .control-btn.toggle-btn {
            background: rgba(255, 255, 255, 0.36);
            color: black;
            font-family: 'Arial Black', Arial, sans-serif;
            font-size: 80%;
        }

        .control-btn.order-btn {
            font-size: 14px;
        }

        .control-btn.order-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .control-btn.warning{
            background: rgba(255, 0, 0, 0);
        }

        .control-btn.warning:hover{
            background: rgba(255, 0, 0, 0.24);
        }

        .control-separator {
            width: 1px;
            height: 20px;
            background-color: rgba(0,0,0,0.2);
            margin: 0 2px;
            flex-shrink: 0; /* Prevent separator from shrinking */
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .close-btn {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(0,0,0,0.1);
            color: #000;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .color-option:hover,
        
        .color-option.selected {
            border-color: #000;
            transform: scale(1.1);
        }

        .color-option::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .color-option.selected::after {
            opacity: 1;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .option-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .option-btn {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .option-btn:hover,
        
        .option-btn.selected {
            background: #000;
            color: #fff;
            border-color: #000;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: #000;
        }

        .empty-state p {
            margin-bottom: 12px;
        }

        .help-text {
            border-radius: 12px;
            padding: 20px;
            margin-top: 50px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .help-text strong {
            color: #000;
        }

        /* Fullscreen Display Mode */
        .display-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: none;
            background-color: black;
        }

        .display-text {
            font-weight: 900;
            text-align: center;
            line-height: 1.1;
            padding: 5%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            hyphens: auto;
            white-space: pre-wrap;
        }

        .stop-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10000;
            transition: all 0.3s ease;
        }

        .stop-btn:hover {
            background: rgba(255,0,0,0.8);
            transform: scale(1.1);
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: toastSlideDown 0.3s ease-out;
        }

        @keyframes toastSlideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .logo {
            height: 90px;
            max-width: 200px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .logo {
                height: 2rem;
            }
        }

        /* Animation Classes */
        .anim-fade-in { animation: fadeIn 0.5s ease-in; }
        .anim-slide-left { animation: slideInLeft 0.5s ease-out; }
        .anim-slide-right { animation: slideInRight 0.5s ease-out; }
        .anim-slide-up { animation: slideInUp 0.5s ease-out; }
        .anim-slide-down { animation: slideInDown 0.5s ease-out; }
        .anim-zoom-in { animation: zoomIn 0.5s ease-out; }
        .anim-pulse { animation: displayPulse 1s ease-in-out infinite; }
        .anim-drop { animation: dropIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .anim-shake { animation: shake 0.5s ease-in-out infinite; }
        .anim-wipe { animation: wipeIn 0.8s ease-out; }
        .anim-flash { animation: flash 0.3s ease-in-out infinite; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-100vw); } to { transform: translateX(0); } }
        @keyframes slideInRight { from { transform: translateX(100vw); } to { transform: translateX(0); } }
        @keyframes slideInUp { from { transform: translateY(100vh); } to { transform: translateY(0); } }
        @keyframes slideInDown { from { transform: translateY(-100vh); } to { transform: translateY(0); } }
        @keyframes zoomIn { from { transform: scale(0.3); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes displayPulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.02); opacity: 0.95; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } 20%, 40%, 60%, 80% { transform: translateX(8px); } }
        @keyframes wipeIn { 0% { clip-path: inset(0 100% 0 0); } 100% { clip-path: inset(0 0 0 0); } }
        @keyframes dropIn { 0% { transform: translateY(-100vh) scale(0.5); } 60% { transform: translateY(0) scale(1.05); } 100% { transform: translateY(0) scale(1); } }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        @media (max-width: 768px) {
            .pages-container {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 20px 16px;
            }

            .page-controls {
                position: absolute;
                bottom: 12px;
                right: 12px;
                z-index: 20;
            }

            .page-controls.collapsed {
                width: 48px;
                height: 48px;
            }
        }
    </style>
</head>
<body>
<div class="container" id="editMode">
    <div class="header">
        <img src="yoLogo1.png" alt="Yo!" class="logo">
        <p>A fullscreen text tool to get your message across. Fast, bold, and from far away.</p>
    </div>

    <div class="controls">
        <div class="btn-split">
            <button class="btn-split-main" onclick="addPage()" title="Add Page">+</button>
            <button class="btn-split-dropdown" onclick="toggleDropdown()" title="Templates">‚úß</button>
        </div>
        <button class="btn btn-play" onclick="startDisplay()" title="Play">‚ñ∂</button>
        <button class="btn btn-clear" onclick="clearAllPages()" title="Clear All">‚úï</button>
        <div class="dropdown">
            <div class="dropdown-content" id="dropdown">
                <div class="dropdown-item" onclick="selectTemplate('emergency')">üö® Emergency</div>
                <div class="dropdown-item" onclick="selectTemplate('accident')">üöó Traffic</div>
                <div class="dropdown-item" onclick="selectTemplate('taxi')">üöï Taxi</div>
                <div class="dropdown-item" onclick="selectTemplate('sports')">üèÜ Sports</div>
                <div class="dropdown-item" onclick="selectTemplate('onAir')">üé§ On Air</div>
                <div class="dropdown-item" onclick="selectTemplate('birthday')">üéÇ Birthday</div>
                <div class="dropdown-item" onclick="selectTemplate('slowdown')">‚ö†Ô∏è Warning</div>
                <div class="dropdown-item" onclick="selectTemplate('airport')">‚úàÔ∏è Airport Pickup</div>
                <div class="dropdown-item" onclick="selectTemplate('protest')">üì¢ Protest</div>
                <div class="dropdown-item" onclick="selectTemplate('brb')">üïí Be right back</div>
                <div class="dropdown-item" onclick="selectTemplate('meeting')">üè¢ Meeting</div>
            </div>
        </div>
    </div>

    <div class="pages-container" id="pagesContainer">
        <div class="empty-state" id="emptyState">
            <h3>No pages yet</h3>
            <p>Click the <strong>+</strong> button to add your first page</p>
            <p>Or try the <strong>‚ãØ</strong> menu for ready-made templates</p>
        </div>
    </div>
</div>

<div class="modal" id="fontModal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('fontModal')">&times;</button>
        <div class="modal-header">Font</div>
        <div class="option-buttons" id="fontOptions">
            <div class="option-btn" data-font="Arial Black, sans-serif" style="font-family: Arial Black, sans-serif;">Arial Black</div>
            <div class="option-btn" data-font="Impact, Arial Black, sans-serif" style="font-family: Impact, Arial Black, sans-serif;">Impact</div>
            <div class="option-btn" data-font="Georgia, serif" style="font-family: Georgia, serif;">Georgia</div>
            <div class="option-btn" data-font="Trebuchet MS, Arial, sans-serif" style="font-family: Trebuchet MS, Arial, sans-serif;">Trebuchet</div>
            <div class="option-btn" data-font="Verdana, Arial, sans-serif" style="font-family: Verdana, Arial, sans-serif;">Verdana</div>
            <div class="option-btn" data-font="Times New Roman, serif" style="font-family: Times New Roman, serif;">Times</div>
            <div class="option-btn" data-font="Courier New, monospace" style="font-family: Courier New, monospace;">Courier</div>
        </div>
    </div>
</div>

<div class="modal" id="animationModal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('animationModal')">&times;</button>
        <div class="modal-header">Animation</div>
        <div class="option-buttons" id="animationOptions">
            <div class="option-btn" data-animation="instant">Instant</div>
            <div class="option-btn" data-animation="pulse">Pulse</div>
            <div class="option-btn" data-animation="flash">Flash</div>
            <div class="option-btn" data-animation="shake">Shake</div>
            <div class="option-btn" data-animation="fade-in">Fade In</div>
            <div class="option-btn" data-animation="wipe">Wipe</div>
            <div class="option-btn" data-animation="slide-left">Slide Left</div>
            <div class="option-btn" data-animation="slide-right">Slide Right</div>
            <div class="option-btn" data-animation="slide-up">Slide Up</div>
            <div class="option-btn" data-animation="slide-down">Slide Down</div>
            <div class="option-btn" data-animation="zoom-in">Zoom In</div>
            <div class="option-btn" data-animation="drop">Drop In</div>
        </div>
    </div>
</div>

<div class="modal" id="colorModal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('colorModal')">&times;</button>
        <div class="modal-header">Colors</div>

        <div class="option-group">
            <label>Text Color</label>
            <div class="color-palette" id="textColorPalette">
                <div class="color-option" style="background-color: #ffffff; border-color: #ddd;" data-color="#ffffff" data-type="text"></div>
                <div class="color-option" style="background-color: #000000" data-color="#000000" data-type="text"></div>
                <div class="color-option" style="background-color: #ef4444" data-color="#ef4444" data-type="text"></div>
                <div class="color-option" style="background-color: #22c55e" data-color="#22c55e" data-type="text"></div>
                <div class="color-option" style="background-color: #3b82f6" data-color="#3b82f6" data-type="text"></div>
                <div class="color-option" style="background-color: #eab308" data-color="#eab308" data-type="text"></div>
                <div class="color-option" style="background-color: #a855f7" data-color="#a855f7" data-type="text"></div>
                <div class="color-option" style="background-color: #06b6d4" data-color="#06b6d4" data-type="text"></div>
                <div class="color-option" style="background-color: #f97316" data-color="#f97316" data-type="text"></div>
                <div class="color-option" style="background-color: #ec4899" data-color="#ec4899" data-type="text"></div>
                <div class="color-option" style="background-color: #84cc16" data-color="#84cc16" data-type="text"></div>
                <div class="color-option" style="background-color: #6366f1" data-color="#6366f1" data-type="text"></div>
            </div>
        </div>

        <div class="option-group">
            <label>Background Color</label>
            <div class="color-palette" id="backgroundColorPalette">
                <div class="color-option" style="background-color: #000000" data-color="#000000" data-type="background"></div>
                <div class="color-option" style="background-color: #ffffff; border-color: #ddd;" data-color="#ffffff" data-type="background"></div>
                <div class="color-option" style="background-color: #ef4444" data-color="#ef4444" data-type="background"></div>
                <div class="color-option" style="background-color: #22c55e" data-color="#22c55e" data-type="background"></div>
                <div class="color-option" style="background-color: #3b82f6" data-color="#3b82f6" data-type="background"></div>
                <div class="color-option" style="background-color: #eab308" data-color="#eab308" data-type="background"></div>
                <div class="color-option" style="background-color: #a855f7" data-color="#a855f7" data-type="background"></div>
                <div class="color-option" style="background-color: #06b6d4" data-color="#06b6d4" data-type="background"></div>
                <div class="color-option" style="background-color: #f97316" data-color="#f97316" data-type="background"></div>
                <div class="color-option" style="background-color: #ec4899" data-color="#ec4899" data-type="background"></div>
                <div class="color-option" style="background-color: #84cc16" data-color="#84cc16" data-type="background"></div>
                <div class="color-option" style="background-color: #6366f1" data-color="#6366f1" data-type="background"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="durationModal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('durationModal')">&times;</button>
        <div class="modal-header">Duration (seconds)</div>
        <div class="option-buttons" id="durationOptions">
            <div class="option-btn" data-duration="0.1">0.1s</div>
            <div class="option-btn" data-duration="0.2">0.2s</div>
            <div class="option-btn" data-duration="0.5">0.5s</div>
            <div class="option-btn" data-duration="1">1s</div>
            <div class="option-btn" data-duration="2">2s</div>
            <div class="option-btn" data-duration="3">3s</div>
            <div class="option-btn" data-duration="4">4s</div>
            <div class="option-btn" data-duration="5">5s</div>
            <div class="option-btn" data-duration="10">10s</div>
        </div>
    </div>
</div>

<script>
    let pages = [];
    let currentPageIndex = 0;
    let currentPageId = null;
    let displayInterval = null;
    let isPlaying = false;

    document.addEventListener('DOMContentLoaded', function() {
        loadPages();
        renderPages();
        registerServiceWorker();
        updatePreviewAspectRatio();

        // Set up resize handlers
        handleResize();
    });

    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'yo-v3'; // Updated cache name if needed
                const urlsToCache = ['/']; // Cache the root
                self.addEventListener('install', function(event) {
                    event.waitUntil(caches.open(CACHE_NAME).then(function(cache) {
                        return cache.addAll(urlsToCache);
                    }));
                });
                self.addEventListener('fetch', function(event) {
                    event.respondWith(caches.match(event.request).then(function(response) {
                        return response || fetch(event.request);
                    }));
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl)
                .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                .catch(error => console.log('ServiceWorker registration failed: ', error));
        }
    }

    function loadPages() {
        const saved = localStorage.getItem('yoPages');
        if (saved) {
            pages = JSON.parse(saved);
        }
    }

    function savePages() {
        localStorage.setItem('yoPages', JSON.stringify(pages));
    }

    function addPage() {
        const page = {
            id: Date.now(),
            text: 'NEW\nPAGE',
            fontFamily: 'Arial Black, sans-serif',
            textColor: '#ffffff',
            backgroundColor: '#000000',
            animation: 'instant',
            duration: 2
        };
        pages.push(page);
        savePages();
        renderPages();
    }

    function deletePage(id) {
        // Find the page element to remove it visually first for smoother UX
        const pageElement = document.querySelector(`.page-item[data-page-id="${id}"]`);
        if (pageElement) {
            pageElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            pageElement.style.opacity = '0';
            pageElement.style.transform = 'scale(0.9)';
            setTimeout(() => {
                pages = pages.filter(page => page.id !== id);
                savePages();
                renderPages(); // Re-render to update indices and buttons
            }, 300);
        } else { // Fallback if element not found (should not happen)
            pages = pages.filter(page => page.id !== id);
            savePages();
            renderPages();
        }
    }

    function duplicatePage(id) {
        const page = pages.find(p => p.id === id);
        if (page) {
            const duplicate = { ...page, id: Date.now() }; // Ensure new unique ID
            const index = pages.findIndex(p => p.id === id);
            pages.splice(index + 1, 0, duplicate);
            savePages();
            renderPages();
        }
    }

    function clearAllPages() {
        // Using a custom modal for confirmation is better, but for now, window.confirm
        // For a real app, replace with a styled modal.
        const userConfirmed = window.confirm('Clear all pages? This cannot be undone.');
        if (userConfirmed) {
            pages = [];
            savePages();
            renderPages();
        }
        // Assuming toggleDropdown was for a menu that might contain this,
        // if it's a general dropdown, it might still be relevant.
        // If not, this line can be removed.
        const dropdown = document.getElementById('dropdown');
        if (dropdown && dropdown.classList.contains('show')) {
            toggleDropdown();
        }
    }

    function selectTemplate(type) {
        // Clear existing pages first
        pages = [];

        let templatePages = [];

        switch(type) {
            case 'airport':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'PICKING UP',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#ffffff',
                        animation: 'instant',
                        duration: 2
                    },
                    {
                        id: Date.now() + 1, // Ensure unique IDs
                        text: 'YOUR\nNAME',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#3b82f6',
                        animation: 'instant',
                        duration: 3
                    }
                ];
                break;
            case 'emergency':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'HELP',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#ef4444',
                        animation: 'flash',
                        duration: 2
                    },
                    {
                        id: Date.now() + 1,
                        text: 'CALL\n911',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#ef4444',
                        animation: 'instant',
                        duration: 3
                    }
                ];
                break;
            case 'taxi':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'TAXI',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#eab308',
                        animation: 'flash',
                        duration: 2
                    },
                    {
                        id: Date.now() + 1,
                        text: 'GOING TO\nAIRPORT',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#ffffff',
                        animation: 'instant',
                        duration: 3
                    }
                ];
                break;
            case 'birthday':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'üéâ\nHAPPY',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#a855f7',
                        animation: 'pulse',
                        duration: 1
                    },
                    {
                        id: Date.now() + 1,
                        text: 'üéà\nBIRTHDAY',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#a855f7',
                        animation: 'pulse',
                        duration: 1
                    },
                    {
                        id: Date.now() + 2,
                        text: '‚ù§\nNAME!',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#ec4899',
                        animation: 'pulse',
                        duration: 3
                    }
                ];
                break;
            case 'meeting':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'TEAM\nMEETING',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#3b82f6',
                        animation: 'flash',
                        duration: 2
                    },
                    {
                        id: Date.now() + 1,
                        text: 'Room A1\nTHIS WAY',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#22c55e',
                        animation: 'instant',
                        duration: 2
                    }
                ];
                break;
            case 'slowdown':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'SLOW\nDOWN',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#eab308',
                        animation: 'instant',
                        duration: 3
                    },
                    {
                        id: Date.now() + 1,
                        text: 'SLOW\nDOWN',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#eab308',
                        animation: 'flash',
                        duration: 2
                    }
                ];
                break;
            case 'accident':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'üö®',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#000000',
                        animation: 'flash',
                        duration: 1
                    },
                    {
                        id: Date.now() + 1,
                        text: 'ACCIDENT\nAHEAD',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#eab308',
                        animation: 'pulse',
                        duration: 3
                    }
                ];
                break;
            case 'protest':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'CHANGE',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#000000',
                        animation: 'drop',
                        duration: 1
                    },
                    {
                        id: Date.now() + 1,
                        text: 'NOW!',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#ffffff',
                        animation: 'drop',
                        duration: 1
                    }
                ];
                break;
            case 'sports':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'LET\'S',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#ffffff',
                        animation: 'instant',
                        duration: 0.5
                    },
                    {
                        id: Date.now() + 1,
                        text: 'GO',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#ffffff',
                        animation: 'instant',
                        duration: 0.5
                    },
                    {
                        id: Date.now() + 2,
                        text: 'üèÜ\nTEAM!',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#000000',
                        backgroundColor: '#eab308',
                        animation: 'shake',
                        duration: 1
                    }
                ];
                break;
            case 'onAir':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'ON AIR',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#ef4444',
                        animation: 'pulse',
                        duration: 2
                    },
                    {
                        id: Date.now() + 1,
                        text: 'ü§´\nQUIET',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#000000',
                        animation: 'flash',
                        duration: 2
                    }
                ];
                break;
            case 'brb':
                templatePages = [
                    {
                        id: Date.now(),
                        text: 'Be Right\nBack',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#3b82f6',
                        animation: 'fade-in',
                        duration: 5
                    },
                    {
                        id: Date.now() + 1,
                        text: 'üèÉ‚Äç‚ôÇÔ∏èüí®',
                        fontFamily: 'Arial Black, sans-serif',
                        textColor: '#ffffff',
                        backgroundColor: '#000000',
                        animation: 'slide-right',
                        duration: 2
                    }
                ];
                break;
        }

        pages = templatePages;
        savePages();
        renderPages();
        toggleDropdown(); // Close dropdown
    }

    function toggleDropdown() {
        document.getElementById('dropdown').classList.toggle('show');
    }

    window.onclick = function(event) {
        if (!event.target.matches('.btn-split-dropdown')) {
            const dropdown = document.getElementById('dropdown');
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        }
        // Close modals if clicking outside their content
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('show');
        }
    }

    function getDeviceLandscapeAspectRatio() {
        const width = Math.max(window.screen.width, window.screen.height);
        const height = Math.min(window.screen.width, window.screen.height);
        return width / height;
    }

    function updatePreviewAspectRatio() {
        const aspectRatio = getDeviceLandscapeAspectRatio();

        // Create or update the dynamic style
        let dynamicStyle = document.getElementById('dynamic-aspect-ratio');
        if (!dynamicStyle) {
            dynamicStyle = document.createElement('style');
            dynamicStyle.id = 'dynamic-aspect-ratio';
            document.head.appendChild(dynamicStyle);
        }

        dynamicStyle.textContent = `
        .page-item {
            aspect-ratio: ${aspectRatio};
        }
    `;
    }

    function renderPages() {
        const container = document.getElementById('pagesContainer');

        if (pages.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No pages yet</h3>
                    <p>Click the <strong>+</strong> button to add your first page</p>
                    <p>Or try the <strong>‚úß</strong> button for ready-made templates</p>
                </div>
            `;
            return;
        }

        const pagesHTML = pages.map((page, index) => createPageHTML(page, index)).join('');
        const helpHTML = `
            <div class="help-text">
                <strong>üí° Quick Tips:</strong><br><br>
                Tap a page to edit its text<br>Tap <b>(‚Ä¶)</b> to customize colors & animations<br>Hit ‚ñ∂ to play fullscreen
            </div>
        `;

        container.innerHTML = pagesHTML + helpHTML;
        attachPageEventListeners();
    }

    function createPageHTML(page, index) {
        const isFirst = index === 0;
        const isLast = index === pages.length - 1;

        return `
            <div class="page-item" data-page-id="${page.id}">
                <div class="page-preview" style="font-family: ${page.fontFamily}; color: ${page.textColor}; background: ${page.backgroundColor};">
                    <div class="page-text" data-page-id="${page.id}" contenteditable="true" spellcheck="false">${page.text}</div>
                    <div class="page-controls collapsed" id="controls-${page.id}">
                        <button class="control-btn" onclick="openModal('fontModal', ${page.id})" title="Font">A</button>
                        <button class="control-btn" onclick="openModal('animationModal', ${page.id})" title="Animation">‚ö°</button>
                        <button class="control-btn" onclick="openModal('colorModal', ${page.id})" title="Colors">üé®</button>
                        <button class="control-btn" onclick="openModal('durationModal', ${page.id})" title="Duration">‚è≥</button>
                        
                        <div class="control-separator"></div>
                        <button class="control-btn order-btn" onclick="movePageUp(${page.id})" ${isFirst ? 'disabled' : ''} title="Move Up">‚ñ≤</button>
                        <button class="control-btn order-btn" onclick="movePageDown(${page.id})" ${isLast ? 'disabled' : ''} title="Move Down">‚ñº</button>
                        <div class="control-separator"></div>
                        
                        <button class="control-btn" onclick="duplicatePage(${page.id})" title="Duplicate">‚ßâ</button>
                        <button class="control-btn warning" onclick="deletePage(${page.id})" title="Delete">üóëÔ∏è</button>
                        <button class="control-btn toggle-btn" onclick="toggleControls(${page.id})" title="Controls">‚ãØ</button>
                    </div>
                </div>
            </div>
        `;
    }

    function attachPageEventListeners() {
        const container = document.getElementById('pagesContainer');

        // Handle text changes
        container.addEventListener('input', function(e) {
            if (e.target.classList.contains('page-text')) {
                const pageId = parseInt(e.target.getAttribute('data-page-id'));
                updatePage(pageId, 'text', e.target.innerText); // Using innerText for contenteditable
                adjustTextSize(e.target);
            }
        });
        // Adjust text size for all textareas on initial load and re-render
        document.querySelectorAll('.page-text').forEach(textarea => {
            adjustTextSize(textarea);
            // Also re-attach blur listener if needed for saving, though input covers most cases
            textarea.addEventListener('blur', function(e) {
                const pageId = parseInt(e.target.getAttribute('data-page-id'));
                // Make sure to save the final text on blur, as 'input' might not catch all changes (e.g., paste)
                updatePage(pageId, 'text', e.target.innerText);
            });
        });
    }

    function handleResize() {
        updatePreviewAspectRatio();

        // Only re-adjust preview text if we're in edit mode
        if (!isPlaying) {
            document.querySelectorAll('.page-text').forEach(adjustTextSize);
        }
    }

    window.addEventListener('resize', handleResize);
    
    window.addEventListener('orientationchange', function() {
        // Small delay to ensure the viewport has updated
        setTimeout(handleResize, 100);
    });

    function adjustTextSize(textarea) {
        const container = textarea.parentElement; // The .page-preview div
        if (!container) return;
        const text = textarea.innerText;

        const fontSize = calculatePreviewFontSize(text, container);
        textarea.style.fontSize = fontSize + 'px';
    }

    function calculatePreviewFontSize(text, container) {
        const maxWidth = container.clientWidth * 0.9;
        const maxHeight = container.clientHeight * 0.9;

        const safeMaxWidth = maxWidth / 1.05;
        const safeMaxHeight = maxHeight / 1.05;

        const lines = text.split('\n');
        const longestLine = lines.reduce((longest, line) =>
            line.length > longest.length ? line : longest, '');

        if (longestLine.length === 0 && lines.length === 1) { // Handle empty or single empty line
            return Math.min(safeMaxHeight / 1.2, 60); // Default size for empty
        }


        let fontSize = Math.min(
            safeMaxWidth / (longestLine.length * 0.65 || 1), // Avoid division by zero
            safeMaxHeight / (lines.length * 1.2 || 1) // Avoid division by zero
        );

        const testElement = document.createElement('div');
        testElement.style.position = 'absolute';
        testElement.style.visibility = 'hidden';
        testElement.style.pointerEvents = 'none'; // Ensure it doesn't interfere with clicks
        testElement.style.fontSize = fontSize + 'px';
        testElement.style.lineHeight = '1.1';
        testElement.style.whiteSpace = 'pre-wrap';
        testElement.style.wordWrap = 'break-word';
        testElement.style.fontFamily = getComputedStyle(container).fontFamily; // Use computed style
        testElement.style.fontWeight = getComputedStyle(container).fontWeight; // Use computed style
        testElement.style.textAlign = 'center';
        testElement.style.maxWidth = safeMaxWidth + 'px'; // Max width for test element
        testElement.textContent = text;

        document.body.appendChild(testElement);

        // Fine-tune size
        while (testElement.offsetWidth < safeMaxWidth * 0.8 &&
        testElement.offsetHeight < safeMaxHeight * 0.8 &&
        fontSize < 800) { // Max font size cap
            fontSize *= 1.06;
            testElement.style.fontSize = fontSize + 'px';
        }

        while ((testElement.offsetWidth > safeMaxWidth ||
            testElement.offsetHeight > safeMaxHeight) &&
        fontSize > 16) { // Min font size cap
            fontSize *= 0.96;
            testElement.style.fontSize = fontSize + 'px';
        }

        document.body.removeChild(testElement);
        return Math.max(fontSize, 16); // Ensure minimum font size
    }

    function toggleControls(pageId) {
        const controls = document.getElementById(`controls-${pageId}`);
        controls.classList.toggle('collapsed');
    }

    function movePageUp(pageId) {
        const index = pages.findIndex(p => p.id === pageId);
        if (index > 0) {
            [pages[index], pages[index - 1]] = [pages[index - 1], pages[index]];
            savePages();
            renderPages(); // Re-render to update visual order and button states
        }
    }

    function movePageDown(pageId) {
        const index = pages.findIndex(p => p.id === pageId);
        if (index < pages.length - 1) {
            [pages[index], pages[index + 1]] = [pages[index + 1], pages[index]];
            savePages();
            renderPages(); // Re-render to update visual order and button states
        }
    }

    function updatePage(id, field, value) {
        const page = pages.find(p => p.id === id);
        if (page) {
            page[field] = value;
            savePages();
            // Only re-render fully if it's not a text update,
            // as text updates are handled by contenteditable and adjustTextSize.
            if (field !== 'text') {
                renderPages();
            } else {
                // If it IS a text update, ensure the preview reflects it if not already handled
                const pagePreviewDiv = document.querySelector(`.page-item[data-page-id="${id}"] .page-preview`);
                if (pagePreviewDiv) {
                    // This might be redundant if adjustTextSize already updates, but good for safety
                    // No, this is not needed here as contenteditable handles the visual text.
                }
            }
        }
    }

    function openModal(modalId, pageId) {
        currentPageId = pageId;
        const modal = document.getElementById(modalId);
        modal.classList.add('show');
        updateModalSelections(modalId, pageId);
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
        }
    }

    function updateModalSelections(modalId, pageId) {
        const page = pages.find(p => p.id === pageId);
        if (!page) return;

        const modalElement = document.getElementById(modalId);
        if (!modalElement) return;

        // Clear previous selections within this specific modal
        modalElement.querySelectorAll('.selected').forEach(el => {
            el.classList.remove('selected');
        });

        // Set current selection
        if (modalId === 'fontModal') {
            modalElement.querySelector(`#fontOptions [data-font="${page.fontFamily}"]`)?.classList.add('selected');
        } else if (modalId === 'animationModal') {
            modalElement.querySelector(`#animationOptions [data-animation="${page.animation}"]`)?.classList.add('selected');
        } else if (modalId === 'colorModal') {
            modalElement.querySelector(`#textColorPalette [data-color="${page.textColor}"]`)?.classList.add('selected');
            modalElement.querySelector(`#backgroundColorPalette [data-color="${page.backgroundColor}"]`)?.classList.add('selected');
        } else if (modalId === 'durationModal') {
            modalElement.querySelector(`#durationOptions [data-duration="${page.duration}"]`)?.classList.add('selected');
        }
    }

    document.addEventListener('click', function(e) {
        const target = e.target;

        if (target.hasAttribute('data-font')) {
            updatePage(currentPageId, 'fontFamily', target.getAttribute('data-font'));
            closeModal('fontModal');
        } else if (target.hasAttribute('data-animation')) {
            updatePage(currentPageId, 'animation', target.getAttribute('data-animation'));
            closeModal('animationModal');
        } else if (target.hasAttribute('data-color')) {
            const colorType = target.getAttribute('data-type');
            if (colorType === 'text') {
                updatePage(currentPageId, 'textColor', target.getAttribute('data-color'));
            } else if (colorType === 'background') {
                updatePage(currentPageId, 'backgroundColor', target.getAttribute('data-color'));
            }
            // Re-update selections in color modal without closing
            if (currentPageId) updateModalSelections('colorModal', currentPageId);
        } else if (target.hasAttribute('data-duration')) {
            updatePage(currentPageId, 'duration', parseFloat(target.getAttribute('data-duration')));
            closeModal('durationModal');
        }
    });

    async function startDisplay() {
        if (pages.length === 0) {
            // Show toast notification
            let msgEl = document.getElementById('tempMessage');
            if (!msgEl) {
                msgEl = document.createElement('div');
                msgEl.id = 'tempMessage';
                msgEl.className = 'toast';
                document.body.appendChild(msgEl);
            }
            msgEl.textContent = 'Add some pages first!';
            setTimeout(() => msgEl.remove(), 3000);
            return;
        }

        currentPageIndex = 0;
        isPlaying = true;

        document.getElementById('editMode').style.display = 'none';

        const displayContainer = document.createElement('div');
        displayContainer.className = 'display-mode';
        displayContainer.id = 'displayContainer';

        const stopButton = document.createElement('button');
        stopButton.className = 'stop-btn';
        stopButton.innerHTML = '√ó';
        stopButton.onclick = stopDisplay;
        displayContainer.appendChild(stopButton);

        const textContainer = document.createElement('div');
        textContainer.className = 'display-text';
        textContainer.id = 'displayText';
        displayContainer.appendChild(textContainer);

        document.body.appendChild(displayContainer);

        try {
            if (document.documentElement.requestFullscreen) { // Check on documentElement
                await document.documentElement.requestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) { /* Firefox */
                await document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                await document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) { /* IE/Edge */
                await document.documentElement.msRequestFullscreen();
            }
        } catch (err) {
            console.log('Fullscreen not available or denied:', err);
        }

        try {
            if (screen.orientation && screen.orientation.lock) {
                await screen.orientation.lock('landscape-primary');
                await new Promise(resolve => setTimeout(resolve, 300)); // Give time for orientation
            }
        } catch (err) {
            console.log('Orientation lock not available or failed:', err);
        }

        showPage(currentPageIndex); // Start with the first page
    }

    function showPage(index) {
        if (!isPlaying) return; // Stop if not playing

        currentPageIndex = index; // Update current page index

        if (currentPageIndex >= pages.length) {
            currentPageIndex = 0; // Loop back to start
        }
        if (pages.length === 0) { // Should be caught by startDisplay, but as a safeguard
            stopDisplay();
            return;
        }


        const page = pages[currentPageIndex];
        const displayText = document.getElementById('displayText');
        if (!displayText) { // Safety check if display mode was exited abruptly
            stopDisplay();
            return;
        }


        displayText.className = 'display-text'; // Reset classes

        displayText.style.fontFamily = page.fontFamily;
        displayText.style.color = page.textColor;
        displayText.style.backgroundColor = page.backgroundColor; // Apply background color

        displayText.textContent = page.text;
        const fontSize = calculateDisplayFontSize(page.text, displayText);
        displayText.style.fontSize = fontSize + 'px';

        if (page.animation !== 'instant') {
            displayText.classList.add('anim-' + page.animation);
        }

        clearTimeout(displayInterval);
        displayInterval = setTimeout(() => {
            showPage(currentPageIndex + 1); // Show next page
        }, page.duration * 1000);
    }

    function calculateDisplayFontSize(text, container) {
        const maxWidth = container.clientWidth * 0.95;
        const maxHeight = container.clientHeight * 0.95;

        const safeMaxWidth = maxWidth / 1.05;
        const safeMaxHeight = maxHeight / 1.05;

        const lines = text.split('\n');
        const longestLine = lines.reduce((longest, line) =>
            line.length > longest.length ? line : longest, '');

        if (longestLine.length === 0 && lines.length === 1) {
            return Math.min(safeMaxHeight / 1.2, 100); // Default for empty
        }

        let fontSize = Math.min(
            safeMaxWidth / (longestLine.length * 0.65 || 1),
            safeMaxHeight / (lines.length * 1.2 || 1)
        );

        const testElement = document.createElement('div');
        testElement.style.position = 'absolute';
        testElement.style.visibility = 'hidden';
        testElement.style.pointerEvents = 'none';
        testElement.style.fontSize = fontSize + 'px';
        testElement.style.lineHeight = '1.1';
        testElement.style.whiteSpace = 'pre-wrap';
        testElement.style.wordWrap = 'break-word';
        // Ensure fontFamily and fontWeight are correctly inherited or set for measurement
        testElement.style.fontFamily = getComputedStyle(container).fontFamily;
        testElement.style.fontWeight = getComputedStyle(container).fontWeight;
        testElement.style.textAlign = 'center';
        testElement.textContent = text;

        document.body.appendChild(testElement);

        while (testElement.offsetWidth < safeMaxWidth * 0.8 &&
        testElement.offsetHeight < safeMaxHeight * 0.8 &&
        fontSize < 800) {
            fontSize *= 1.06;
            testElement.style.fontSize = fontSize + 'px';
        }

        while ((testElement.offsetWidth > safeMaxWidth ||
            testElement.offsetHeight > safeMaxHeight) &&
        fontSize > 16) {
            fontSize *= 0.96;
            testElement.style.fontSize = fontSize + 'px';
        }

        document.body.removeChild(testElement);
        return Math.max(fontSize, 16);
    }

    function stopDisplay() {
        isPlaying = false;
        clearTimeout(displayInterval);

        try {
            if (screen.orientation && screen.orientation.unlock) {
                screen.orientation.unlock();
            }
        } catch (err) {
            console.log('Orientation unlock failed:', err);
        }

        if (document.fullscreenElement) { // Check if in fullscreen
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) { /* Firefox */
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) { /* Chrome, Safari & Opera */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE/Edge */
                document.msExitFullscreen();
            }
        }


        const displayContainer = document.getElementById('displayContainer');
        if (displayContainer) {
            displayContainer.remove();
        }

        document.getElementById('editMode').style.display = 'block';

        setTimeout(() => { // Ensure DOM is updated before recalculating
            updatePreviewAspectRatio(); // Update aspect ratio for previews
            document.querySelectorAll('.page-text').forEach(adjustTextSize);
        }, 100);
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (isPlaying) {
                stopDisplay();
            } else {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        }
    });
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange); // Firefox
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange); // Chrome, Safari, Opera
    document.addEventListener('msfullscreenchange', handleFullscreenChange); // IE/Edge

    function handleFullscreenChange() {
        const isFullscreen = !!(document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
        if (!isFullscreen && isPlaying) {
            // If fullscreen was exited while playing (e.g., by user pressing Esc), stop the display.
            stopDisplay();
        }
    }

    window.addEventListener('resize', function() {
        if (isPlaying) {
            const displayText = document.getElementById('displayText');
            if (displayText && pages.length > 0 && pages[currentPageIndex]) { // Check if elements and page exist
                const page = pages[currentPageIndex];
                const fontSize = calculateDisplayFontSize(page.text, displayText);
                displayText.style.fontSize = fontSize + 'px';
            }
        }
        // The general handleResize already covers edit mode.
    });

</script>
</body>
</html>